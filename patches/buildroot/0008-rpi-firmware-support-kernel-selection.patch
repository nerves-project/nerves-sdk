From 051314c88ce05dab0e8884e68aa6269abdd6c4a1 Mon Sep 17 00:00:00 2001
From: Frank Hunleth <fhunleth@troodon-software.com>
Date: Wed, 29 Mar 2017 08:59:03 -0400
Subject: [PATCH] rpi-firmware: support kernel selection

---
 package/rpi-firmware/Config.in         | 23 +++++++++++++++++++++++
 package/rpi-firmware/rpi-firmware.hash |  2 ++
 package/rpi-firmware/rpi-firmware.mk   | 10 ++++++++++
 3 files changed, 35 insertions(+)

diff --git a/package/rpi-firmware/Config.in b/package/rpi-firmware/Config.in
index 0ebbe7a4cd..0c427de62c 100644
--- a/package/rpi-firmware/Config.in
+++ b/package/rpi-firmware/Config.in
@@ -11,6 +11,29 @@ config BR2_PACKAGE_RPI_FIRMWARE
 
 if BR2_PACKAGE_RPI_FIRMWARE
 
+choice
+	bool "Linux kernel version"
+	default BR2_PACKAGE_RPI_FIRMWARE_KERNEL_4_4
+	help
+	  Select firmware files for a particular Linux kernel
+
+config BR2_PACKAGE_RPI_FIRMWARE_KERNEL_4_4
+	bool "linux 4.4"
+	help
+	  Firmware from the Linux 4.4 branch
+
+config BR2_PACKAGE_RPI_FIRMWARE_KERNEL_4_9
+	bool "linux 4.9"
+	help
+	  Firmware from the Linux 4.9 branch
+
+config BR2_PACKAGE_RPI_FIRMWARE_KERNEL_4_14
+	bool "linux 4.14"
+	help
+	  Firmware from the Linux 4.14 branch
+
+endchoice
+
 choice
 	bool "Firmware to boot"
 	default BR2_PACKAGE_RPI_FIRMWARE_DEFAULT
diff --git a/package/rpi-firmware/rpi-firmware.hash b/package/rpi-firmware/rpi-firmware.hash
index 728c53fe9a..7ca2d15fa5 100644
--- a/package/rpi-firmware/rpi-firmware.hash
+++ b/package/rpi-firmware/rpi-firmware.hash
@@ -1,2 +1,4 @@
 # Locally computed
 sha256 57c56e9e41a2d9b1ce660aa7887db5c4b44f768fc63c6b6ef1d2fe460a090d85 rpi-firmware-fbad6408c4596d3d671736ee0571aae444f24e68.tar.gz
+sha256 5edff641f216d2e09c75469dc2e9fc66aff290e212a1cd43ed31c499f99ea055 rpi-firmware-287af2a2be0787a5d45281d1d6183a2161c798d4.tar.gz
+sha256 2d2775bcfecd92aec06685efb7461258e996cfbfc6ce9b8a791b73883c7fee4f rpi-firmware-b51046a2b2bb69771579a549d157205d9982f858.tar.gz
diff --git a/package/rpi-firmware/rpi-firmware.mk b/package/rpi-firmware/rpi-firmware.mk
index bb54904ae6..b3386a7e72 100644
--- a/package/rpi-firmware/rpi-firmware.mk
+++ b/package/rpi-firmware/rpi-firmware.mk
@@ -4,7 +4,17 @@
 #
 ################################################################################
 
+ifeq ($(BR2_PACKAGE_RPI_FIRMWARE_KERNEL_4_4),y)
+RPI_FIRMWARE_VERSION = b51046a2b2bb69771579a549d157205d9982f858
+else
+ifeq ($(BR2_PACKAGE_RPI_FIRMWARE_KERNEL_4_9),y)
+RPI_FIRMWARE_VERSION = 287af2a2be0787a5d45281d1d6183a2161c798d4
+else
+# Linux 4.14
 RPI_FIRMWARE_VERSION = fbad6408c4596d3d671736ee0571aae444f24e68
+endif
+endif
+
 RPI_FIRMWARE_SITE = $(call github,raspberrypi,firmware,$(RPI_FIRMWARE_VERSION))
 RPI_FIRMWARE_LICENSE = BSD-3-Clause
 RPI_FIRMWARE_LICENSE_FILES = boot/LICENCE.broadcom
-- 
2.17.2 (Apple Git-113)

